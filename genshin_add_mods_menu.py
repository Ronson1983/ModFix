# Made by ronson83
# Version 0.1
# Added mod menu for each mod

# ############################################################################################################################
#                                                              |c                                                             
#                                                             @                                                               
#                                                            @    @@@       @                                                 
#                                                            @  @@            "                                               
#                                                            @  @                                                             
#                                                            @      -@@@@@@@@@@@@@                                            
#                                                              @@@@@@aOddMJaOdOdd@@@@@                                        
#                                                            @@@Jd@OMMdOOOOOJMOdOOOda@@@                                      
#                                                         I@@dMdOOOOOOO@c@OOOaOMOOdddOO@@@                                    
#                                                       @a@JdddOOOOOOOOdOOJ@cOca@JOOdOddd@@                                   
#                                                     @ @dMOacddMdddadOdOddJa@JJ@aOOdOddddM@                                  
#                                                      @@c@OOdOacOJJOddaJaJOOJacJ@JJaddOdcd@@                                 
#                                                    - @@@J@JdOOMdddaJdjcacMJa@@@@@dOJddddOO@@                                
#                                                     @  @@@@@@dda@MdO@O@MOaa@>  @-@d@adOOadO@                                
#                                                   > -@ a>@  @@a@ @@@-d@>aa@@ O{@ @OajOOdOddM@                               
#                                                  d@  @  @I {  @@  @@@@@M@@d@--@  @c@JaOdOOOO@@                              
#                                                @   @ @ M@ @j@ c  @M @@ "@ @@@ >@@Mc@cMOdOOJaO@@                             
#                                              @    @O @O@@a @@@     @ M"   @{ j@IMacaOaOOOMaaO@@                             
#                                           @ @   @J@@@aOM@ M@@  "   { @ @@@  M@  @@aOOOMOOaO@O@ @                            
#                                            @  a |Mad@a@d@            @@@@-@ @@@@@M@OJJMOOMO@ @d@                            
#                                              > @@d@O@@@O@ " O       @ @@   M@    @cJM@Jaaa@@ @ j                            
#                                            j   @@@>@ @@@@                @@@@ "  @dMdJJd@ @ d@ @                            
#                                             I@ @ @ @  j@@  Ij "       -@{@d@    @@dMdO@@@@  @  @                            
#                                              {O@       @ @    I"  @@   @d@M a@@@@@@@@@d@ @ @  @                             
#                                                @  d@    O@@@       -@@@@@|@@@@@@ @ @  @ @    @                              
#                                                @ >  @@cM  "{@    @@@@ c|@@@O @   @  d  |   "                                
#                                     >--@@@@@@@add@d |dd   O{dO@@@J - I          c                                           
#                                      -   a@@@@@d@  jO>da@@Jj|@  "{ @--I-j@@@@                                               
#                                    I jca@I       cJJj@@ I @  @       c@>I   @                                               
#                                 Mc@@@@@"        @@a@-  |@  @           j{ |                                                 
#                              @@@@@@@dJO      @@@@@  {@    c            J @   I                                              
#                                      > @ad@@M@j   @     c{              O >  -@                                             
#                                       @M@d@ d       MMJO>               c @ |                                               
#                                     @@|   d    "--     -                c @ >{ @                                            
#                                         M M        " " @ {" >>>>>>{cI  {I>      @                                           
#                                       @@@  >     c         Oc>   {  d a  I J {  M"                                          
#                                       {@ a@{|{d  |   """  Jd   c   I{O   a @|@  @ >             M@@@@M@@                    
#                                      @@@d@ c{>>>Mc       c       " Ij {I I @    >         @@           I@@I                 
#                                    @@@@      j@ >||cI          -    M > "  M  a "|     @@                 @@                
#                               I >d-         @     c->{{|{|jcJd      >   """{     -  "@@                    O@               
#                               "  >  @ @   @        c|"   ">-      "a "    @ {> aj  @@                      @                
#                                    @    @            |@@J       c||| > j  @    j @@                        @                
#                             @j@@@ @   @            @@"  @@@@@@@@@  "   O{@  j @cM                         @                 
#                             @@@    >>            @I "c{{ j  -@@@M@@| @"  M   Oaa                         @                  
#                           M@@@ |M-             @I">| -       > @@@@@@@  a" aM   c O@@@@@@@@@@@@@@|      @                   
#                          @@@    >           Ij>|I-{      J   {    @@@@@IMa@@M@@                  @@@a@@@                    
#                        @@@@   |           @>|j{-jI  "     c   J  j  @@@ @>@d c-  @J                  @   @@                 
#                       @@@    @           @>O   |j   " |    j  c  O"  J@ I>  @@dac   d             J@       >@               
#                     @@@@    c  "        J>-    cj   " { " """  a  a  j O"       @OMdM@@-       O@@           @J             
#                    @@@     -           jj{     |j  " "   "    " >  M  {"a         aO  @@@@@@@@@                @            
#                  @@@@      "         @|cI |     c      {  " "  | >  c   J@         @M  M                        @           
#                 @@@       "         M|    |     Od "  J I  I     |-      J@         "@ @           |>I  >       @           
#               @@@@     a  "       @-j     -  "   c        "        |>  j   @          @J        c        j     @d-          
#             {@@@      @      >  >--"j      "      M    - j       "  I    j  @          @>  I"I"   "|O> Ica    @Jj           
#            @@@@      M         JcO j       " "         d  J           {      @a    c" |{@-                > {@@             
#          c@@@                O-{|  O  "    - "     -    >  O            "|    M@ a|-  @J O@@@    I>>>"    @cjI  -           
#         @@@d      @ "      @J->|  O"    "" J  "     I"" O   J      -       @    dM    |@    a@Mad@@@@@@{      >{jI|d- {     
#   @@c" @@@      j        @ |I>-> -J   O       "         >O   J      {        dJ  Mj@"dJ                 -Ja>        I>jI>>  
#  @       {    "{  "    {  j|| "  J          c   "      > c"   O  "   |         "d| M{c  -JMJ        I|I      "    "      "  
#             a         M  -||     d " {      -  I      " { c    a  "  " I          I>J|a@      "- "       c      "           
#             -       @    d>  J  j  " |       O   ""       JJ   "c     " |          @  j>@@                  O>     -{ {Jc   
#                   "     M       a     "      {       "     dJ    dI  "  ""|    "  @      I@@O           """    @"    |  >   
# J@@j             @     M    O       I "       a  "" "        M    >d    "   -    @          @M c|           "    @d         
# M    I@ "I"""I-">     d  "     c" " { "    "  >j         "    M     a"    "   "@     I ""     @jI c>   - "    "    {cadd|   
#           "             "  |   >  " |    "     O        "       II    a      @c c          I    @JJ  |    "-                
#                      |I    - J  " " {    " I "  d           ""  ""         @@     @       "       @dj  "I    { -        >   
#                        I     "  I   - "  "  I   >|         "  "    |    @d@         @         "     @@    >    >  {     >   
#                     -{ I  {  I-     -     " " "  dc   "        "     @aO@             dJ          "   d@   I     |  {  JI   
#                    I-  "  {  j- "   { |      "    O{             @O@O@      J           Oa             MM    J "     OcJ    
#                        "  "  J> " " { @    " "" "  J        @@@@a@-     >    |"           Od  I-        @@         c{  -I   
#                   {      "   J      { J    ""       |M@M@@@O         "    J   Ic           -cJ   -"      "@  "  I @{--      
#                  -       "   c      >         M@@@@" c       "      "  "     { "O            Occ    J      @       |{|      
#                  "       |   a         O@@@I          O I >           "      |  -J            -jJ     j     @  "    c-      
#                 - "      j   d     @@M O       "   "  >I - O            " "    " "O             j{-     |    @      j>Oj>   
#                I "       -    |@@    >  j       "      j  | O"           "  ""  J  >   |         J-J     ""   @    >j>  I   
#              jI "   M     I@@ J    "    O             " |  | cO         " ""      d  |   "{       >-c >    c  J      -{>    
#             I  "    j "@M@    a       j IO     "  "      -  - jJ           I  I    d"  |    |" {   -{{ a    c  @            
#           {        @cO@  "{O       " "   O>      " -   "        a"       "" "       jd   ""    > I  j|  a    -  @  "        
#       -I    a>O @a|@>   I-I>|j -    "  O  |      "  {"           >{       "I "        O   j   "  c"  cJ  d    | @@     M    
#      @j{j{{" >c{@ II     J|{I--|   ""   " Oj         d "      {"   j        " I        O   I       |j O  --  a"  @   Jc -   
#       {>I  M||O"--|j       O{-{j|    " "   d-I       "@        |>"  c        "          O    I-  "   >c   O {-|  @@cdj@     
#       O- @>a """-Ij          >Ij   " " ""|  jJ{cj|{    O -       j           "           a    jI      >   O||J    @         
#        @O@>">>>->>|   "OjJj{O-j{   "  " " - I>>>-I|{c   | {   "   >"I ">""      " c    "  a "  {I"  "   "  {   j  @|        
#      d@d   "j->-II{{|j->I>>"-"II{j        >j||{-j{--|{{||  -     {      >           I         "   c      Ij|jjJ   @a        
#    "@d      -IIIIII""I"I"I-II"I>"-{-         "     >II"I>>         -     {           | I   >  " "  |       ">j    OJ        
#   Jc         -II""""I>>"I " """"" "I{     -I      >I""I""I{>      I                   >  "         {I  |-II       jj        
#  >                ""                  "I"" -"I""I                      "   "  >        "" "         """           -I        
#                                                                                                                   "         
#                                                                                                                             
#                                                                                                                             
# ############################################################################################################################

import os
import re
import shutil
from datetime import datetime
import argparse

IGNORE_DEACTIVATED_FILE = True
DEBUG = True
DEFINED_BUTTON = 'OEM_PLUS'
OVERWRITE = False

template_text_file = '''
<<name>>

[<<button>>] To toggle Help Menu

TOGGLES=========================
<<toggles>>
=========================TOGGLES

'''.format(length='multi-line', ordinal='second')

help_ini_template = '''
[Constants]
global $active = 0
global $help = 0

[Present]
post $active = 0

[KeyHelp]
condition = $active == 1
key = <<button>>
type = toggle
$help = 1
run = CommandListHelp

[KeyHelpOff]
condition = $active == 0 && $help == 1
key = <<button>>
$help = 0
run = CommandListHelpNull

[TextureOverrideCharacterPosition]
hash = <<CharacterHash>>
match_priority = 100
$active = 1

[CommandListHelp]
; The pre commands run when the F1 key is first pressed. Set the current help
; text to the full help text and run the formatting shader
pre Resource\ShaderFixes\help.ini\Help = ref ResourceNotesFull
pre Resource\ShaderFixes\help.ini\Params = ref ResourceParamsFull
pre run = CustomShader\ShaderFixes\help.ini\FormatText
; Setting the short help text to null disables the timeout in the present
; command list:
pre Resource\ShaderFixes\help.ini\HelpShort = null
; The post commands run when the help key is pressed again. Set the current
; help text to null to disable the help shader:
post Resource\ShaderFixes\help.ini\Help = null

[CommandListHelpNull]
post Resource\ShaderFixes\help.ini\Help = null

; Custom resources that load the long and short help text from file:
[ResourceNotesFull]
type = buffer
format = R8_UINT
filename = togglehelp.txt

; Using these parameter buffers as a way to pass in constant parameters without
; taking up any of the IniParams slots while still allowing the parameters to
; be customised on a per-message basis.
[ResourceParamsFull]
type = StructuredBuffer
array = 1
data = R32_FLOAT   -.3 -1 0 1      0.2 0.5 0.8 1    0 0 0 0.3   0.02 0.02     2 2   0   1.5
;                 ^^^^Rectangle^^ | ^^^Colour^^^ | Background  | ^Border^^ | ^ ^ | ^ | ^-- font scale
;                  x1   y1  x2  y2 | r g   b    a | r g b a    | horz vert |  ^  | ^------ text alignment: 0=left 1=center 2=right
;                   range -1:+1   |              | r g b a     | horz vert |  ^----------- h/v-anchor: 0=none 1=left/top 2=center 3=right/bottom
'''.format(length='multi-line', ordinal='second')

def dprint(input):
	global DEBUG
	
	if DEBUG:
		print(input)

def parse_ini(content):
	blocks = []
	lines = []
	
	token = content.split("\r\n")

	if len(token) == 1:
		token = content.splitlines()

	# analyse und in blöcke packen
	has_run = False
	has_internal_run = False
	has_ps_t = False
	has_if = False
	has_normalmap = False
	is_type = ''
	last_block = 'root'
	for line in token:
		original_line = line = line.split('\n')[0]
		line = re.sub('[\s+]', '', line)
		
		if line.startswith('[') and line.endswith(']'):
			if is_type == '':
				is_type = last_block.replace('[', '').replace(']', '')
			
			data = {}
			data['lines'] = lines
			data['has_run'] = has_run
			data['has_internal_run'] = has_internal_run
			data['has_ps_t'] = has_ps_t
			data['has_if'] = has_if
			data['has_normalmap'] = has_normalmap
			data['type'] = is_type
			data['block_name'] = last_block
			blocks.append(data)
			
			last_block = line
			lines = []
			has_run = False
			has_internal_run = False
			has_ps_t = False
			has_if = False
			has_normalmap = False
			is_type = ''
			
		if line.startswith('ps-t'):
			has_ps_t = True
			
			if "NormalMap" in line:
				has_normalmap = True
			
		if line.startswith('run'):
			has_run = True
			if '\\' not in line:
				has_internal_run = True
			
		if "endif" in line:
			has_if = True
			
		if line.startswith('vb'):
			is_type = 'vb'
		elif line.startswith('ib'):
			is_type = 'ib'
		elif line.startswith('type'):
			is_type = 'resource'
		elif line.startswith('filename'):
			is_type = 'resource'
		elif line.startswith('condition'):
			is_type = 'condition'

		lines.append(original_line)

	# letzter Block
	if is_type == '':
		is_type = last_block.replace('[', '').replace(']', '')
	
	data = {}
	data['lines'] = lines
	data['has_run'] = has_run
	data['has_internal_run'] = has_internal_run
	data['has_ps_t'] = has_ps_t
	data['has_if'] = has_if
	data['has_normalmap'] = has_normalmap
	data['type'] = is_type
	data['block_name'] = last_block
	blocks.append(data)
	
	return blocks

def check_ini_for_keys(content):
	retval = {}
	retval['has_keys'] = False
	retval['has_still_menu'] = False
	
	keys = []
	
	blocks = parse_ini(content)

	# bearbeiten
	for my_block in blocks:
		if 'Texture' in my_block['block_name'] and 'Position' in my_block['block_name'] and 'CharacterHash' not in retval:
			for line in my_block['lines']:
				if line.startswith('hash'):
					retval['CharacterHash'] = line.split('=')[1].strip()

		key_data = {}
		key_data['key'] = []
		for line in my_block['lines']:
			if re.sub('[\s+]', '', line).startswith('key') or re.sub('[\s+]', '', line).startswith('back'):
				retval['has_keys'] = True
				key_data['key'].append(line.split('=')[1].strip())
				key_data['text'] = my_block['block_name'].replace('[', '').replace(']', '')
				
		if len(key_data['key']) > 0:
			keys.append(key_data)

		if 'Menu' in my_block['block_name'] and 'Toggle' in my_block['block_name']:
			retval['has_still_menu'] = True

	retval['keys'] = keys

	dprint(retval)
	return retval

def create_files(ini_data, filepath):
	global help_ini_template, template_text_file, DEFINED_BUTTON
	path = os.path.dirname(filepath)
	token = path.split('\\')
	name = token[len(token)-1]
	
	ht = help_ini_template.replace('<<CharacterHash>>', ini_data['CharacterHash'])
	ht = ht.replace('<<button>>', DEFINED_BUTTON)
	
	with open(path + '\\help.ini', 'w') as f:
		f.write(ht)
				
	ttf = template_text_file.replace('<<name>>', name)
	ttf = ttf.replace('<<button>>', DEFINED_BUTTON)
	
	key_line = ''
	for key in ini_data['keys']:
		key_line = key_line + '[' + '] or ['.join(key['key']) + '] ' + key['text'] + "\n"
	
	ttf = ttf.replace('<<toggles>>', key_line.strip())		
	with open(path + '\\togglehelp.txt', 'w') as f:
		f.write(ttf)

def process_directory(directory):
	global IGNORE_DEACTIVATED_FILE, OVERWRITE
	
	num_changed = 0
	num_skipped = 0
	errors = []
	
	for root, dirs, files in os.walk(directory):
		for file in files:
			if file.lower() == 'help.ini':
				print('Übersprungen')
				continue
				
			if file.lower().endswith('.ini'):
				file_path = os.path.join(root, file)
				
				print(file_path.replace(directory, '...'))
				if IGNORE_DEACTIVATED_FILE and "DISABLED" in file_path:
					print('Übersprungen')
					num_skipped = num_skipped + 1
					continue
				
				path = os.path.dirname(file_path)
				if os.path.exists(path + '\\help.ini') and OVERWRITE == False:
					print('Existiert bereits! Übersprungen')
					num_skipped = num_skipped + 1
					continue
				
				try:
					with open(file_path, 'r', encoding='utf-8') as f:
						content = f.read()

						data = check_ini_for_keys(content)
						if data['has_keys'] == True and data['has_still_menu'] == False:
							create_files(data, file_path)
							num_changed = num_changed + 1
							
						elif data['has_still_menu'] == True:
							print('Hat bereits ein Menu! Übersprungen')
							num_skipped = num_skipped + 1
						else:
							print('Kein Key gefunden! Übersprungen')
							num_skipped = num_skipped + 1
						
				except Exception as e:
					print(f"Fehler: {file_path} - {str(e)}")
					errors.append(f"Fehler: {file_path} - {str(e)}")
					
	return num_changed, num_skipped, errors

if __name__ == "__main__":
	parser = argparse.ArgumentParser()
	parser.add_argument('--force_overwrite', action='store_true',default=False)
	parser.add_argument("-m", "--menuKey", type=str, help="Key for menu opener")
	args = parser.parse_args()
	
	if args.force_overwrite:
		OVERWRITE = True
	
	if args.menuKey:
		DEFINED_BUTTON = args.menuKey
	
	current_dir = os.getcwd()
	print(f"Ordner: {current_dir}")
	num_changed, num_skipped, errors = process_directory(current_dir)
	print(f"Verändert: {num_changed} Übersprungen: {num_skipped} Fehlerhaft: {len(errors)}")
	if len(errors) > 0:
		print('Fehlerhaft! Bitte prüfen:')
		for error in errors:
			print(error)
	print("Fertig!")